---
import { sanity } from "../../lib/sanity";
import { postBySlug, postSlugs } from "../../lib/queries";
import { ptToHtml } from "../../lib/portableText";
import { urlFor } from "../../lib/sanity";

export async function getStaticPaths() {
  const slugs = await sanity.fetch(postSlugs); // [{ slug: "moxa-boxes" }, ...]
  return slugs.map(({ slug }) => ({ params: { slug } }));
}

const { slug } = Astro.params;
const post = await sanity.fetch(postBySlug, { slug });
if (!post) throw new Error("Post not found");

const bodyHtml = ptToHtml(post.body);
---

<article style="max-width:720px;margin:2rem auto;padding:1rem">
  <h1>{post.title}</h1>
  {
    post.publishedAt && (
      <p>
        <time datetime={post.publishedAt}>
          {new Date(post.publishedAt).toLocaleDateString()}
        </time>
      </p>
    )
  }
  {
    post.mainImage && (
      <img
        src={urlFor(post.mainImage).width(1600).fit("max").url()}
        alt={post.title}
        style="width:100%;height:auto;border-radius:1rem"
      />
    )
  }
  <div set:html={bodyHtml} />
</article>
